name: Repository Audit

on:
  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes made)'
        required: false
        default: 'false'
        type: boolean
      priorities:
        description: 'Priority levels to process (comma-separated: critical,high,medium,low)'
        required: false
        default: 'critical,high,medium,low'
        type: string
      create_pr:
        description: 'Create PR with changes'
        required: false
        default: 'true'
        type: boolean
  
  # Scheduled run (weekly on Monday)
  schedule:
    - cron: '0 6 * * 1'
  
  # Trigger on new repository creation or transfer
  repository_dispatch:
    types: [audit-repo]

permissions:
  contents: write
  pull-requests: write

jobs:
  audit:
    name: Run Repository Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run pattern analysis
        id: analyze
        run: |
          echo "üîç Analyzing repository patterns..."
          node scripts/analyze-patterns.js . --json > /tmp/analysis.json 2>&1 || true
          
          # Extract score from output
          SCORE=$(node -e "
            const fs = require('fs');
            try {
              const data = JSON.parse(fs.readFileSync('/tmp/analysis.json', 'utf-8').split('--- JSON Output ---')[1] || '{}');
              console.log(data.score?.percentage || 0);
            } catch { console.log(0); }
          ")
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Current score: $SCORE%"

      - name: Generate configurations
        if: inputs.dry_run != 'true' && github.event_name != 'schedule'
        id: generate
        run: |
          PRIORITIES="${{ inputs.priorities || 'critical,high,medium,low' }}"
          
          echo "üîß Generating configurations..."
          echo "   Priorities: $PRIORITIES"
          
          node scripts/audit-repo.js . \
            --priorities=$PRIORITIES \
            ${{ inputs.dry_run == 'true' && '--dry-run' || '' }}
          
          # Count generated files
          GENERATED=$(git status --porcelain | wc -l)
          echo "generated_count=$GENERATED" >> $GITHUB_OUTPUT

      - name: Validate configurations
        if: inputs.dry_run != 'true'
        run: |
          echo "‚úÖ Validating configurations..."
          
          # Validate JSON files
          for file in package.json .vscode/settings.json .vscode/extensions.json; do
            if [ -f "$file" ]; then
              node -e "JSON.parse(require('fs').readFileSync('$file', 'utf-8').replace(/^\uFEFF/, ''))" && \
                echo "  ‚úì $file is valid" || \
                echo "  ‚úó $file is invalid"
            fi
          done
          
          # Validate YAML files (basic check)
          for file in .github/dependabot.yml .github/workflows/*.yml; do
            if [ -f "$file" ]; then
              if grep -q $'\t' "$file" 2>/dev/null; then
                echo "  ‚úó $file contains tabs"
              else
                echo "  ‚úì $file appears valid"
              fi
            fi
          done

      - name: Create Pull Request
        if: inputs.dry_run != 'true' && (inputs.create_pr == 'true' || github.event_name == 'schedule')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: repository audit - add missing configurations'
          title: 'üîç Repository Audit: Configuration Updates'
          body: |
            ## Repository Audit Results
            
            This PR was automatically generated by the repository audit workflow.
            
            ### Changes Made
            - Added missing configuration files based on best practices
            - Updated package.json with recommended fields
            - Generated documentation
            
            ### Initial Score
            ${{ steps.analyze.outputs.score }}%
            
            ### Files Changed
            ${{ steps.generate.outputs.generated_count }} files modified
            
            ---
            *Generated by [repo-audit.yml](.github/workflows/repo-audit.yml)*
          branch: audit/configuration-updates
          delete-branch: true
          labels: |
            automated
            configuration
            audit

      - name: Commit directly (scheduled runs)
        if: github.event_name == 'schedule' && inputs.create_pr != 'true'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore: scheduled repository audit updates"
            git push
            echo "‚úÖ Changes committed directly"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: Summary
        run: |
          echo "## Repository Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Initial Score | ${{ steps.analyze.outputs.score }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Files Generated | ${{ steps.generate.outputs.generated_count || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ inputs.dry_run || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See AUDIT_RESULTS.md for detailed report." >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify Results
    needs: audit
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Notify on failure
        run: |
          echo "‚ö†Ô∏è Repository audit failed"
          echo "Check the workflow logs for details"
